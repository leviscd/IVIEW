<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPVIEW - TV Express Style</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js CDN (for playing M3U8 streams) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.0"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary-dark: #0F071A;
            --color-focus-glow: #9333EA;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-primary-dark);
            color: #E5E7EB; /* Light gray text */
            overflow: hidden; /* Prevent scrolling for full-screen feel */
        }

        /* Custom focus style (Smart TV feel) */
        .focusable {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s ease-in-out;
            cursor: pointer;
            outline: none !important;
        }

        .focusable.focused {
            transform: scale(1.06);
            box-shadow: 0 0 0 6px rgba(147, 51, 234, 0.5), /* Inner Glow */
                        0 0 20px 0 var(--color-focus-glow); /* Outer Glow */
            z-index: 10; /* Ensure focused item stays on top */
        }

        /* Player view specific styling */
        #player-view {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Subtle Background Animation (Violet Pulse) */
        .background-pulse {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            background: radial-gradient(circle at 10% 10%, rgba(109, 40, 217, 0.1) 0%, transparent 20%),
                        radial-gradient(circle at 90% 90%, rgba(147, 51, 234, 0.1) 0%, transparent 20%);
            animation: pulse-bg 15s infinite alternate;
        }

        @keyframes pulse-bg {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.1); opacity: 1; }
        }

        /* Glassmorphism for the main button */
        .glass-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background 0.2s;
        }
        .glass-btn:hover, .glass-btn.focused {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Estilo para os controles na tela */
        #on-screen-controls {
            z-index: 55; /* Acima do footer */
        }
        #on-screen-controls button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</head>
<body>
    <!-- Background Effect -->
    <div class="background-pulse"></div>

    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen w-full relative p-4 lg:p-8">

        <!-- Home View (Logo + Main Button) -->
        <div id="home-view" class="flex flex-col items-center justify-center min-h-screen">
            <div id="eye-logo" class="mb-10 w-48 h-48 lg:w-64 lg:h-64 relative">
                <!-- SVG Eye (Minimalistic, ready for JS animation) -->
                <svg viewBox="0 0 100 100" class="w-full h-full text-violet-400 fill-current" preserveAspectRatio="xMidYMid meet">
                    <!-- Outer Shape (Eye Ball) -->
                    <circle cx="50" cy="50" r="45" stroke="#9333EA" stroke-width="2" fill="none" opacity="0.8"/>
                    <!-- Pupil (Animated) -->
                    <circle id="pupil" cx="50" cy="50" r="15" fill="#6D28D9" class="transition-all duration-500 ease-in-out"/>
                    <!-- Glare / Highlight (Static) -->
                    <circle cx="58" cy="42" r="4" fill="white" opacity="0.6"/>
                    <!-- Eyelid Overlay (Animated for Blinking) -->
                    <path id="eyelid-overlay" d="M 0 0 L 100 0 L 100 0 C 75 25, 25 25, 0 0 Z" fill="var(--color-primary-dark)" class="origin-top transition-transform duration-100"/>
                </svg>
            </div>
            <h1 class="text-5xl lg:text-7xl font-extrabold mb-8" style="background-image: linear-gradient(to right, #6D28D9, #9333EA); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                IPVIEW
            </h1>
            <button id="main-btn-watch" data-action="categories" tabindex="0" class="focusable glass-btn py-4 px-12 text-lg lg:text-xl font-semibold rounded-xl tracking-wider uppercase">
                ASSISTIR TV AO VIVO
            </button>
        </div>

        <!-- Categories and Channels View Container -->
        <div id="content-view" class="hidden w-full h-full">
            
            <!-- Top Bar (Header) -->
            <header class="flex justify-between items-center h-16 mb-4 lg:mb-8">
                <div class="flex items-center space-x-2">
                    <svg viewBox="0 0 100 100" class="w-8 h-8 text-violet-400 fill-current" preserveAspectRatio="xMidYMid meet">
                        <circle cx="50" cy="50" r="45" stroke="#9333EA" stroke-width="2" fill="none" opacity="0.8"/>
                        <circle cx="50" cy="50" r="15" fill="#6D28D9"/>
                    </svg>
                    <span class="text-xl font-bold">IPVIEW</span>
                </div>
                <div class="text-lg font-semibold text-violet-300">
                    <span id="current-view-title"></span>
                </div>
            </header>

            <div class="flex h-[calc(100vh-8rem)]"> <!-- Altura ajustada para responsividade -->
                <!-- Main Grid Area -->
                <main id="grid-area" class="w-full lg:w-3/4 pr-0 lg:pr-8 overflow-y-auto custom-scrollbar">
                    <!-- Content (Categories or Channels) rendered here -->
                </main>

                <!-- Info Banner (Desktop/TV Only) -->
                <aside id="info-banner" class="hidden lg:block lg:w-1/4 p-4 rounded-xl shadow-lg bg-gray-800/30 border border-gray-700/50">
                    <div class="flex flex-col h-full text-gray-300">
                        <h3 class="text-2xl font-bold text-violet-300 mb-4">Informa√ß√£o do Canal</h3>
                        <div id="banner-placeholder-image" class="w-full h-auto bg-gray-700 rounded-lg mb-4 aspect-video flex items-center justify-center">
                            <span class="text-sm">Mini-Poster / Placeholder</span>
                        </div>
                        <p id="banner-channel-name" class="text-xl font-semibold text-white mb-2">Canal Selecionado</p>
                        <p id="banner-program-title" class="text-lg text-violet-200 mb-1">Programa Atual: Sem dados de EPG</p>
                        <p id="banner-program-time" class="text-sm text-gray-400">Tempo restante: 30 minutos (Fict√≠cio)</p>
                        <p id="banner-channel-desc" class="mt-4 text-sm text-gray-400 italic">
                            Use as setas para navegar e ENTER para abrir o player.
                        </p>
                    </div>
                </aside>
            </div>
        </div>
        
        <!-- Player View (Full screen overlay) -->
        <div id="player-view" class="fixed inset-0 bg-black hidden flex-col items-center justify-center" style="z-index: 100;">
            <div id="lag-indicator" class="hidden absolute top-4 right-4 bg-red-700 text-white px-3 py-1 rounded-full text-sm font-bold z-110">
                <svg class="w-4 h-4 inline-block mr-1 align-text-bottom" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                LAG/ERRO
            </div>
            <video id="video-player" class="w-full h-full object-contain" autoplay muted playsinline></video>
            
            <!-- Overlay para bloquear clique/pause no v√≠deo -->
            <div id="video-click-blocker" class="absolute inset-0 z-[101]"></div>

            <!-- Overlay de Informa√ß√£o do Canal (Auto-hide) -->
            <div id="player-channel-info-overlay" class="absolute top-4 left-4 bg-black/70 p-4 rounded-lg shadow-lg z-[105] transition-opacity duration-500 opacity-0 hidden">
                <span id="player-info-number" class="block text-5xl font-extrabold text-violet-300"></span>
                <span id="player-info-name" class="block text-3xl font-semibold text-white"></span>
            </div>

            <!-- Player Info Bar (Auto-hide manual) -->
            <div id="player-controls-bar" class="absolute top-0 left-0 w-full p-4 bg-black/60 transition-opacity duration-500 z-[102]" style="opacity: 0;">
                <div class="flex justify-between items-center">
                    <span id="player-channel-name" class="text-3xl font-bold text-white"></span>
                    <span class="text-lg text-gray-400">Pressione SPACE ou ENTER para mostrar/ocultar barra</span>
                </div>
            </div>

            <!-- Fullscreen Button (for non-TV environments) -->
            <button id="fullscreen-btn" class="absolute bottom-4 right-4 bg-violet-600 hover:bg-violet-700 text-white p-3 rounded-full shadow-lg focusable z-[102]" onclick="toggleFullscreen()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5m0 11v-4m0 4h-4m4 0l-5-5m-11 5h4m-4 0v-4m0 4l5-5"></path></svg>
            </button>
        </div>

        <!-- Numeric Input Overlay -->
        <div id="numeric-overlay" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white text-7xl font-bold p-8 rounded-xl hidden z-[120]">
            0
        </div>

        <!-- "ASSISTIR" Button for Mobile/Tablet Fixed at Bottom -->
        <button id="mobile-assistir-btn" data-action="categories" tabindex="0" class="focusable glass-btn py-3 px-8 text-base font-semibold rounded-xl tracking-wider uppercase fixed bottom-4 left-4 right-4 z-50 lg:hidden">
            ASSISTIR TV AO VIVO
        </button>
        
        <!-- Vertical Button for Desktop/TV Fixed at Left -->
        <button id="desktop-assistir-btn" data-action="categories" tabindex="0" class="focusable glass-btn py-3 px-8 text-base font-semibold rounded-xl tracking-wider uppercase fixed top-1/2 left-[-30px] transform -translate-y-1/2 rotate-90 z-50 hidden lg:block">
            ASSISTIR TV AO VIVO
        </button>

        <!-- Controles de Navega√ß√£o On-Screen (Setas) -->
        <div id="on-screen-controls" class="fixed bottom-4 right-4 grid grid-cols-3 gap-2 p-3 bg-black/30 backdrop-blur-sm rounded-xl">
            <div></div> <!-- C√©lula vazia -->
            <button id="nav-up" class="glass-btn rounded-lg text-white" onclick="triggerKey('ArrowUp')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
            </button>
            <div></div> <!-- C√©lula vazia -->
            <button id="nav-left" class="glass-btn rounded-lg text-white" onclick="triggerKey('ArrowLeft')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <button id="nav-ok" class="glass-btn rounded-lg text-white font-bold" onclick="triggerKey('Enter')">OK</button>
            <button id="nav-right" class="glass-btn rounded-lg text-white" onclick="triggerKey('ArrowRight')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
            <div></div> <!-- C√©lula vazia -->
            <button id="nav-down" class="glass-btn rounded-lg text-white" onclick="triggerKey('ArrowDown')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div></div> <!-- C√©lula vazia -->
        </div>

    </div>
    
    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 w-full text-center py-2 text-xs text-gray-500 bg-gray-900/10 z-50">
        Powered by Levi
    </footer>

    <script type="text/javascript">
        // --- CONFIGURA√á√ÉO INICIAL E DADOS ---

        // Vari√°veis globais obrigat√≥rias (n√£o utilizadas no front-end, mas exigidas pelo ambiente)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const CHANNEL_DATA = {
            "esportes": [
                { "nome": "Premiere 1", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/d485d118d525ae4326aa31371f5dfcef/premiere.m3u8" },
                { "nome": "Premiere 2", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/aa1f6257eeb308e3e6677bae5fb7f1c8/premiere2.m3u8" }
            ],
            "noticias": [
                { "nome": "Record News", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/3728ae10c1a4f5b4a394d9771ec12db2/record.m3u8" }
            ],
            "infantil": [
                { "nome": "Cartoon Network", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/f67e159151a581847c31a461034c795a/cartoonnetwork.m3u8" },
                { "nome": "Nickelodeon", "url": "https://d1muf25xa11soq8hp22.s27-usa-cloudfront-net.online/token/528246d1903b4743bca33088eedc800f/nickelodeon.m3u8" }
            ],
            "filmes_e_series": [
                { "nome": "Telecine Premium", "url": "https://placehold.co/400x225/ba55d3/ffffff?text=Telecine" },
                { "nome": "HBO HD", "url": "https://placehold.co/400x225/4b0082/ffffff?text=HBO" }
            ],
            "variedades": [
                { "nome": "Multishow", "url": "https://placehold.co/400x225/daa520/000000?text=Multi" },
                { "nome": "GNT", "url": "https://placehold.co/400x225/808080/ffffff?text=GNT" }
            ]
        };

        // Estado Global da Aplica√ß√£o
        let currentView = 'home';
        let viewHistory = []; // Para navega√ß√£o Backspace/Escape
        let focusElement = null;
        let numericInput = '';
        let numericTimeout = null;
        let autoHideTimer = null;
        let channelInfoTimeout = null; // Timer para o overlay de info do canal
        let hlsPlayer = null;
        let currentChannelObject = null;
        const allChannels = [];

        // Mapeamento e indexa√ß√£o de todos os canais para troca r√°pida (TV Express style)
        let globalIndex = 1;
        for (const categoryKey in CHANNEL_DATA) {
            CHANNEL_DATA[categoryKey].forEach(channel => {
                channel.globalIndex = globalIndex++;
                channel.categoryKey = categoryKey;
                channel.categoryName = categoryKey.replace(/_/g, ' ').toUpperCase();
                allChannels.push(channel);
            });
        }

        // --- FUN√á√ïES DE UTILITY E FOCO ---

        /** Define o elemento com foco (Smart TV feel). */
        function setFocus(element) {
            if (focusElement) {
                focusElement.classList.remove('focused');
                focusElement.blur();
            }
            if (element) {
                element.classList.add('focused');
                element.focus();
                focusElement = element;
                
                // For channel cards, update the info banner
                if (element.classList.contains('channel-card')) {
                    updateInfoBanner(element.dataset.channelIndex);
                } else if (currentView === 'channels') {
                    // Hide banner content if focus leaves a channel card
                    updateInfoBanner();
                }
            }
        }
        
        /** Atualiza o banner lateral com as informa√ß√µes do canal. */
        function updateInfoBanner(globalIndex = null) {
            const banner = document.getElementById('info-banner');
            const placeholder = document.getElementById('banner-placeholder-image');
            const channelName = document.getElementById('banner-channel-name');
            const programTitle = document.getElementById('banner-program-title');
            const programTime = document.getElementById('banner-program-time');
            const channelDesc = document.getElementById('banner-channel-desc');

            if (!banner || banner.classList.contains('hidden')) return;

            if (globalIndex) {
                const channel = allChannels[globalIndex - 1];
                if (!channel) return;

                // Fictional EPG/Description Data
                const progName = `Jornal ${channel.nome.split(' ')[0]}`;
                const progDesc = `Assista agora o melhor do ${channel.categoryKey.replace(/_/g, ' ')} com coment√°rios exclusivos.`;

                channelName.textContent = `#${channel.globalIndex} - ${channel.nome}`;
                programTitle.textContent = `Programa Atual: ${progName}`;
                programTime.textContent = `Tempo restante: ${Math.floor(Math.random() * 45) + 5} minutos (Fict√≠cio)`;
                channelDesc.textContent = progDesc;
                placeholder.innerHTML = `<img src="${channel.url.includes('placehold.co') ? channel.url : `https://placehold.co/400x225/6D28D9/ffffff?text=${channel.nome.replace(' ', '+')}`}" class="rounded-lg object-cover w-full h-full" onerror="this.onerror=null;this.src='https://placehold.co/400x225/6D28D9/ffffff?text=Sem+Pr√©via';">`;
                placeholder.classList.remove('flex');
                placeholder.classList.add('block');
            } else {
                channelName.textContent = 'Canal Selecionado';
                programTitle.textContent = 'Programa Atual: Sem dados de EPG';
                programTime.textContent = 'Tempo restante: N/A';
                channelDesc.textContent = 'Use as setas para navegar e ENTER para abrir o player.';
                placeholder.innerHTML = `<span class="text-sm">Mini-Poster / Placeholder</span>`;
                placeholder.classList.remove('block');
                placeholder.classList.add('flex');
            }
        }

        /** Algoritmo espacial para navega√ß√£o em grid (Smart TV). */
        function findNextFocus(direction) {
            const focusables = Array.from(document.querySelectorAll('#app-container .focusable:not(.hidden)'));
            if (!focusElement || focusables.length === 0) return focusables[0];

            const currentRect = focusElement.getBoundingClientRect();
            let bestMatch = null;
            let minDistance = Infinity;

            focusables.forEach(el => {
                if (el === focusElement) return;

                const rect = el.getBoundingClientRect();
                let distance = Infinity;
                
                // Calculate distance based on direction
                switch (direction) {
                    case 'ArrowUp':
                        if (rect.bottom < currentRect.top && Math.abs(rect.left - currentRect.left) < currentRect.width * 2) {
                            distance = (currentRect.top - rect.bottom) + Math.abs(currentRect.left - rect.left) * 0.5;
                        }
                        break;
                    case 'ArrowDown':
                        if (rect.top > currentRect.bottom && Math.abs(rect.left - currentRect.left) < currentRect.width * 2) {
                            distance = (rect.top - currentRect.bottom) + Math.abs(currentRect.left - rect.left) * 0.5;
                        }
                        break;
                    case 'ArrowLeft':
                        if (rect.right < currentRect.left && Math.abs(rect.top - currentRect.top) < currentRect.height * 2) {
                            distance = (currentRect.left - rect.right) + Math.abs(currentRect.top - rect.top) * 0.5;
                        }
                        break;
                    case 'ArrowRight':
                        if (rect.left > currentRect.right && Math.abs(rect.top - currentRect.top) < currentRect.height * 2) {
                            distance = (rect.left - currentRect.right) + Math.abs(currentRect.top - rect.top) * 0.5;
                        }
                        break;
                }

                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatch = el;
                }
            });

            return bestMatch;
        }


        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E MAPS (VIEWS) ---
        
        /** Gerencia o estado das views e navega√ß√£o. */
        function Maps(viewName, data = null) {
            // Push current view to history if not the same
            if (viewName !== currentView) {
                 viewHistory.push(currentView);
            }

            currentView = viewName;

            // Esconde todas as views
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('content-view').classList.add('hidden');
            document.getElementById('player-view').classList.add('hidden');
            document.getElementById('mobile-assistir-btn').classList.add('hidden');
            document.getElementById('desktop-assistir-btn').classList.add('hidden');

            // Renderiza a view correta
            let initialFocusElement = null;

            switch (viewName) {
                case 'home':
                    document.getElementById('home-view').classList.remove('hidden');
                    document.getElementById('mobile-assistir-btn').classList.remove('hidden');
                    document.getElementById('desktop-assistir-btn').classList.remove('hidden');
                    initialFocusElement = document.getElementById('main-btn-watch');
                    break;
                case 'categories':
                    document.getElementById('content-view').classList.remove('hidden');
                    renderCategoriesPage();
                    initialFocusElement = document.querySelector('.category-card');
                    break;
                case 'channels':
                    document.getElementById('content-view').classList.remove('hidden');
                    renderChannelsPage(data); // data is categoryKey
                    initialFocusElement = document.querySelector('.channel-card');
                    break;
                case 'player':
                    document.getElementById('player-view').classList.remove('hidden');
                    renderPlayerView(data); // data is channelObj
                    break;
            }

            // Define foco inicial e garante que n√£o estamos no player
            if (viewName !== 'player') {
                setFocus(initialFocusElement);
            }
            
            // Garante que o indicador de view est√° correto
            const viewTitleEl = document.getElementById('current-view-title');
            if (viewTitleEl) {
                if (viewName === 'categories') viewTitleEl.textContent = 'TODAS AS CATEGORIAS';
                else if (viewName === 'channels') viewTitleEl.textContent = data.toUpperCase().replace(/_/g, ' ');
                else viewTitleEl.textContent = '';
            }
        }

        /** Renderiza a tela inicial (Logo + Bot√£o). */
        function renderHomePage() {
            // Conte√∫do j√° est√° no HTML est√°tico, Maps s√≥ precisa tornar vis√≠vel.
        }

        /** Renderiza a grade/lista de categorias. */
        function renderCategoriesPage() {
            const gridArea = document.getElementById('grid-area');
            const categoryKeys = Object.keys(CHANNEL_DATA);

            const cardsHTML = categoryKeys.map(key => {
                const name = key.replace(/_/g, ' ').toUpperCase();
                const iconPlaceholder = key.includes('esportes') ? '‚öΩ' : 
                                        key.includes('noticias') ? 'üì∞' : 
                                        key.includes('infantil') ? 'üß∏' : 
                                        key.includes('filmes') ? 'üé¨' : 'üì∫';

                return `
                    <button class="category-card focusable relative bg-gray-800/50 p-6 rounded-xl overflow-hidden hover:bg-gray-700/50" 
                            tabindex="0" 
                            data-action="channels" 
                            data-key="${key}">
                        <span class="text-4xl block mb-2">${iconPlaceholder}</span>
                        <h2 class="text-xl font-bold">${name}</h2>
                        <span class="text-sm text-gray-400">${CHANNEL_DATA[key].length} Canais</span>
                    </button>
                `;
            }).join('');

            gridArea.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${cardsHTML}
                </div>
            `;
            // Ensure banner is updated/hidden on category view
            updateInfoBanner();
        }

        /** Renderiza a grade de canais de uma categoria. */
        function renderChannelsPage(categoryKey) {
            const gridArea = document.getElementById('grid-area');
            const channels = CHANNEL_DATA[categoryKey];

            const cardsHTML = channels.map(channel => {
                const isPlaceholder = channel.url.includes('placehold.co');
                const channelNumber = channel.globalIndex;
                const favKey = `fav_${channelNumber}`;
                const isFavorite = localStorage.getItem(favKey) === 'true';
                const placeholderImage = isPlaceholder ? channel.url : `https://placehold.co/400x225/6D28D9/ffffff?text=${channel.nome.replace(' ', '+')}`;

                return `
                    <div class="channel-card focusable relative bg-gray-800/50 rounded-xl overflow-hidden hover:bg-gray-700/50" 
                         tabindex="0" 
                         data-action="player" 
                         data-channel-index="${channelNumber}"
                         data-url="${channel.url}"
                         data-nome="${channel.nome}"
                         data-fav-key="${favKey}">
                        <div class="aspect-video">
                            <img src="${placeholderImage}" alt="${channel.nome}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x225/6D28D9/ffffff?text=Sem+Pr√©via';">
                        </div>
                        <div class="p-3">
                            <span class="absolute top-2 left-2 bg-violet-600 px-2 py-1 text-xs font-bold rounded-full">${channelNumber}</span>
                            <span class="absolute top-2 right-2 text-yellow-400 transition-opacity ${isFavorite ? 'opacity-100' : 'opacity-0'} favorite-icon">‚òÖ</span>
                            <h3 class="text-base font-semibold truncate mt-1">${channel.nome}</h3>
                            <p class="text-xs text-gray-400">${channel.categoryName}</p>
                        </div>
                    </div>
                `;
            }).join('');

            gridArea.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${cardsHTML}
                </div>
            `;
            
            // Re-apply focus style on load
            document.querySelectorAll('.channel-card').forEach(card => {
                card.addEventListener('focus', () => setFocus(card));
                card.addEventListener('blur', () => card.classList.remove('focused'));
                card.addEventListener('mouseenter', () => updateInfoBanner(card.dataset.channelIndex));
                card.addEventListener('mouseleave', () => updateInfoBanner());
            });

            // Scroll to the top when a new channel view is rendered
            gridArea.scrollTop = 0;
            updateInfoBanner();
        }

        /** Inicializa o player HLS e exibe o overlay. */
        function renderPlayerView(channelObj) {
            currentChannelObject = channelObj;
            const videoEl = document.getElementById('video-player');
            const channelNameEl = document.getElementById('player-channel-name');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            // Elementos do novo overlay de informa√ß√£o
            const infoOverlay = document.getElementById('player-channel-info-overlay');
            const infoNumber = document.getElementById('player-info-number');
            const infoName = document.getElementById('player-info-name');

            channelNameEl.textContent = channelObj.nome;
            videoEl.muted = true; // Come√ßa mudo
            videoEl.poster = ''; // Limpa poster
            
            // Exibe o overlay de informa√ß√£o do canal
            infoNumber.textContent = channelObj.globalIndex;
            infoName.textContent = channelObj.nome;
            infoOverlay.classList.remove('hidden');
            infoOverlay.classList.remove('opacity-0');

            // Limpa timer antigo (se houver) e seta um novo para esconder a info
            clearTimeout(channelInfoTimeout);
            channelInfoTimeout = setTimeout(() => {
                infoOverlay.classList.add('opacity-0');
                // Adiciona 'hidden' depois que a transi√ß√£o terminar
                setTimeout(() => infoOverlay.classList.add('hidden'), 500); 
            }, 4000); // Exibe por 4 segundos

            // Tenta entrar em fullscreen no player
            if (document.documentElement.requestFullscreen && !document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.warn("Fullscreen negado pelo navegador."));
            }

            // Inicializa ou destr√≥i o player HLS antigo
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // Para canais placeholder que n√£o s√£o M3U8, n√£o inicializa HLS, apenas mostra a imagem
            if (channelObj.url.endsWith('.m3u8')) {
                initializeHlsPlayer(channelObj.url);
                videoEl.poster = ''; // Remove poster if stream is ready
            } else {
                console.warn("URL n√£o √© HLS, usando poster placeholder.");
                videoEl.src = '';
                videoEl.poster = channelObj.url;
                document.getElementById('lag-indicator').classList.remove('hidden');
            }

            // Garante que o v√≠deo tente tocar
            videoEl.play().catch(error => {
                console.warn("Autoplay bloqueado, aguardando intera√ß√£o do usu√°rio.", error);
                // Em muitos navegadores, o HLS.js (ou o clique inicial) j√° lidou com isso.
            });

            // Inicia o timer de auto-hide da barra de controles
            setAutoHideControls();

            // Seta o foco para o player (embora n√£o seja um elemento interativo tradicional)
            setFocus(fullscreenBtn);
        }
        
        // --- PLAYER HLS ---

        /** Inicializa o player HLS com a URL fornecida. */
        function initializeHlsPlayer(url) {
            const video = document.getElementById('video-player');
            const lagIndicator = document.getElementById('lag-indicator');
            lagIndicator.classList.add('hidden'); // Oculta no in√≠cio

            if (Hls.isSupported()) {
                hlsPlayer = new Hls();
                hlsPlayer.on(Hls.Events.MEDIA_ATTACHED, function () {
                    hlsPlayer.loadSource(url);
                });
                hlsPlayer.attachMedia(video);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                    video.play().catch(e => console.warn("Play falhou ap√≥s manifest parsed:", e));
                });

                // Captura eventos de erro/lag
                hlsPlayer.on(Hls.Events.ERROR, function (event, data) {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        lagIndicator.classList.remove('hidden');
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('Fatal network error, trying to recover...');
                                hlsPlayer.recoverMediaError();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error('Fatal media error, trying to recover...');
                                hlsPlayer.recoverMediaError();
                                break;
                            default:
                                console.error('HLS fatal error. Stopping playback.');
                                break;
                        }
                    }
                });
                
                // Evento de stall/buffer vazio
                hlsPlayer.on(Hls.Events.BUFFER_EMPTY, () => lagIndicator.classList.remove('hidden'));
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Suporte nativo do Safari/iOS
                video.src = url;
                video.play().catch(e => console.warn("Play nativo falhou:", e));
                console.log("Usando suporte nativo (Safari).");
            } else {
                // N√£o use alert
                console.error('Seu navegador n√£o suporta HLS.');
            }

            // Evento para ocultar o indicador de lag quando o v√≠deo estiver rodando
            video.addEventListener('playing', () => lagIndicator.classList.add('hidden'));
            video.addEventListener('stalled', () => lagIndicator.classList.remove('hidden'));
        }

        /** Gerencia o timer de auto-hide da barra de controles do player. */
        function setAutoHideControls(timeoutMs = 5000) {
            const controlsBar = document.getElementById('player-controls-bar');
            
            // Limpa o timer anterior
            clearTimeout(autoHideTimer);

            // Mostra a barra
            controlsBar.style.opacity = '1';

            // Inicia o novo timer para ocultar
            autoHideTimer = setTimeout(() => {
                controlsBar.style.opacity = '0';
            }, timeoutMs);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Erro ao tentar fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- MANUSEIO DE TECLADO E INTERA√á√ïES ---

        /** Processa a entrada num√©rica multi-d√≠gito (0-9). */
        function processNumericInput(key) {
            const numericOverlay = document.getElementById('numeric-overlay');
            
            clearTimeout(numericTimeout);
            
            // Limita a 3 d√≠gitos (para n√£o tentar n√∫meros muito grandes)
            if (numericInput.length >= 3) {
                numericInput = key;
            } else {
                numericInput += key;
            }
            
            numericOverlay.textContent = numericInput;
            numericOverlay.classList.remove('hidden');

            const channelNumber = parseInt(numericInput, 10);
            const channelToFocus = allChannels.find(c => c.globalIndex === channelNumber);

            if (channelToFocus) {
                // Canal v√°lido encontrado, espera timeout para confirmar ou digitar mais
                numericTimeout = setTimeout(() => {
                    // Navegar e focar o canal
                    Maps('channels', channelToFocus.categoryKey);
                    
                    // Espera um ciclo do DOM para focar o card renderizado
                    setTimeout(() => {
                        const targetCard = document.querySelector(`.channel-card[data-channel-index="${channelToFocus.globalIndex}"]`);
                        if (targetCard) {
                            setFocus(targetCard);
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        numericInput = '';
                        numericOverlay.classList.add('hidden');
                    }, 50);

                }, 1200); // 1.2s timeout
            } else {
                // Canal inv√°lido (ou n√∫mero incompleto) - apenas espera o timeout
                numericTimeout = setTimeout(() => {
                    // Feedback visual de "shake" ou erro aqui (opcional)
                    console.log(`Canal #${numericInput} n√£o encontrado ou inv√°lido.`);
                    numericInput = '';
                    numericOverlay.classList.add('hidden');
                }, 1200);
            }
        }
        
        /** Handler principal de eventos de teclado. */
        function handleKeyDown(e) {
            const key = e.key;

            // 1. Teclas Num√©ricas (0-9) - Prioridade m√°xima para troca r√°pida
            if (currentView !== 'player' && key >= '0' && key <= '9') {
                e.preventDefault();
                processNumericInput(key);
                return;
            }
            
            // Se estiver em input num√©rico, s√≥ aceita n√∫meros
            if (numericInput.length > 0 && !(key >= '0' && key <= '9')) {
                clearTimeout(numericTimeout);
                numericInput = '';
                document.getElementById('numeric-overlay').classList.add('hidden');
            }

            // 2. Comportamento no Player View
            if (currentView === 'player') {
                if (key === 'Escape' || key === 'Backspace') {
                    e.preventDefault();
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    if (hlsPlayer) {
                        hlsPlayer.destroy();
                        hlsPlayer = null;
                    }
                    Maps(viewHistory.pop() || 'home');
                } else if (key === 'Enter' || key === ' ') {
                    e.preventDefault();
                    setAutoHideControls(); // Apenas alterna visibilidade dos controles
                } else if (key === 'm' || key === 'M') {
                    e.preventDefault();
                    const video = document.getElementById('video-player');
                    video.muted = !video.muted;
                    console.log(`Mute: ${video.muted ? 'ON' : 'OFF'}`);
                } else if (key === 'ArrowUp' || key === 'ArrowDown') {
                    e.preventDefault();
                    if (!currentChannelObject) return;

                    let currentIndex = currentChannelObject.globalIndex - 1; // 0-based index
                    
                    if (key === 'ArrowUp') {
                        // Pr√≥ximo canal (√≠ndice maior)
                        currentIndex = (currentIndex + 1) % allChannels.length;
                    } else {
                        // Canal anterior (√≠ndice menor)
                        currentIndex = (currentIndex - 1 + allChannels.length) % allChannels.length;
                    }
                    
                    const newChannelObj = allChannels[currentIndex];
                    if (newChannelObj) {
                        renderPlayerView(newChannelObj);
                    }
                }
                return;
            }

            // A√ß√£o (Enter/Space)
            if (key === 'Enter' || key === ' ') {
                e.preventDefault();
                if (focusElement) {
                    const action = focusElement.dataset.action;
                    if (action === 'categories') {
                        Maps('categories');
                    } else if (action === 'channels') {
                        Maps('channels', focusElement.dataset.key);
                    } else if (action === 'player') {
                        const channelIndex = focusElement.dataset.channelIndex;
                        const channelObj = allChannels[channelIndex - 1];
                        if (channelObj) {
                            Maps('player', channelObj);
                        }
                    }
                }
                return;
            }

            // Voltar/Escape
            if (key === 'Escape' || key === 'Backspace') {
                e.preventDefault();
                const previousView = viewHistory.pop();
                if (previousView) {
                    Maps(previousView);
                } else {
                    Maps('home');
                }
                return;
            }

            // Home
            if (key === 'Home') {
                e.preventDefault();
                viewHistory = [];
                Maps('home');
                return;
            }

            // Favoritar Canal ('C')
            if (currentView === 'channels' && (key === 'c' || key === 'C') && focusElement && focusElement.classList.contains('channel-card')) {
                e.preventDefault();
                const card = focusElement;
                const favKey = card.dataset.favKey;
                const isFavorite = localStorage.getItem(favKey) === 'true';
                
                if (isFavorite) {
                    localStorage.setItem(favKey, 'false');
                    card.querySelector('.favorite-icon').style.opacity = '0';
                } else {
                    localStorage.setItem(favKey, 'true');
                    card.querySelector('.favorite-icon').style.opacity = '1';
                }
                return;
            }
        }
        
        /** Simula um evento de teclado (para bot√µes na tela). */
        function triggerKey(key) {
            console.log("Triggering key: ", key);
            const event = new KeyboardEvent('keydown', {
                key: key,
                bubbles: true,
                cancelable: true
            });
            window.dispatchEvent(event);
        }
        
        // --- ANIMA√á√ïES E INICIALIZA√á√ÉO ---

        /** Controla as anima√ß√µes do Logo (Blink, Pupil, Glow). */
        function startEyeAnimations() {
            const pupil = document.getElementById('pupil');
            const eyelid = document.getElementById('eyelid-overlay');

            // 1. Blink
            function blink() {
                eyelid.style.transform = 'scaleY(1)'; // Close
                setTimeout(() => {
                    eyelid.style.transform = 'scaleY(0)'; // Open
                    setTimeout(blink, Math.random() * 4000 + 3000); // Wait 3s to 7s
                }, 100); // Blink fast (close time)
            }
            eyelid.style.transform = 'scaleY(0)'; // Start open
            setTimeout(blink, 3000);

            // 2. Pupil Movement (Subtle Jitter)
            function movePupil() {
                const tx = Math.random() * 8 - 4; // -4 to +4
                const ty = Math.random() * 8 - 4;
                pupil.style.transform = `translate(${tx}px, ${ty}px)`;
                setTimeout(movePupil, 1000); // Move every second
            }
            movePupil();

            // 3. Simple Glow (via CSS or subtle JS) - CSS handles glow, JS adds subtle jitter to the whole logo
            const eyeLogo = document.getElementById('eye-logo');
            function jitter() {
                const rz = Math.random() * 0.5 - 0.25; // -0.25deg to +0.25deg
                const jx = Math.random() * 0.2 - 0.1; // -0.1px to +0.1px
                eyeLogo.style.transform = `rotate(${rz}deg) translateX(${jx}px)`;
                setTimeout(jitter, 100);
            }
            jitter();
        }

        /** Ponto de entrada da aplica√ß√£o. */
        window.onload = function () {
            // Inicializa as anima√ß√µes
            startEyeAnimations();

            // Seta o handler de teclado global
            window.addEventListener('keydown', handleKeyDown);
            
            // Delega√ß√£o de evento para cliques nos bot√µes de a√ß√£o (mais robusto)
            document.body.addEventListener('click', function(e) {
                // Encontra o elemento clicado ou seu pai que tenha data-action
                const actionElement = e.target.closest('[data-action]');
                
                if (actionElement) {
                    const action = actionElement.dataset.action;
                    
                    if (action === 'categories') {
                        Maps('categories');
                    } else if (action === 'channels') {
                        Maps('channels', actionElement.dataset.key);
                    } else if (action === 'player') {
                        const channelIndex = actionElement.dataset.channelIndex;
                        const channelObj = allChannels[channelIndex - 1];
                        if (channelObj) {
                            Maps('player', channelObj);
                        }
                    }
                }
            });

            // Oculta/Mostra controles on-screen baseado na view
            // (Esta l√≥gica pode ser movida para a fun√ß√£o Maps se ficar complexa)
            if (currentView === 'player' || currentView === 'home') {
                document.getElementById('on-screen-controls').classList.add('hidden');
            }

            // Inicia na Home View
            Maps('home');
        };

    </script>
</body>
</html>
