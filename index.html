<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPVIEW</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0"></script>

  <style>
    :root{
      --bg:#000000;
      --violet-1:#6D28D9;
      --violet-2:#9333EA;
      --glass: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.36);
      --focus-glow: 0 18px 48px rgba(147,51,234,0.45);
    }
    html,body,#app{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#fff;background:var(--bg);-webkit-font-smoothing:antialiased}

    /* Animated abstract background */
    .bg-abstract{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
    .blob{position:absolute;width:80vmax;height:80vmax;border-radius:50%;filter:blur(100px);mix-blend-mode:screen}
    .b1{background:radial-gradient(circle at 30% 30%, rgba(109,40,217,0.22), transparent 30%);left:-30%;top:-20%}
    .b2{background:radial-gradient(circle at 70% 70%, rgba(147,51,234,0.18), transparent 30%);right:-30%;bottom:-20%}

    main{position:relative;z-index:10;min-height:100vh}

    /* Home / Eye centered */
    .home-wrap{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:22px;text-align:center}
    .logo-wrap{width:260px;height:260px;display:flex;align-items:center;justify-content:center}
    .brand-title{font-weight:800;letter-spacing:6px;font-size:1.6rem;background:linear-gradient(90deg,var(--violet-1),var(--violet-2));-webkit-background-clip:text;background-clip:text;color:transparent}

    .logo-svg{width:100%;height:100%;filter:drop-shadow(0 30px 80px rgba(0,0,0,0.7))}
    .iris{transition:transform 1.6s cubic-bezier(.2,.9,.3,1);transform-origin:center}
    .pupil{transition:transform 1.6s cubic-bezier(.2,.9,.3,1);transform-origin:center;filter:drop-shadow(0 12px 30px rgba(147,51,234,0.28))}

    .start-btn{position:relative;z-index:20;padding:14px 26px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.04);font-weight:700}
    .home-footer{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--muted);z-index:20}

    /* Screens */
    .screen{position:fixed;inset:0;display:none;padding:22px;z-index:20}
    .screen.active{display:block}

    /* Categories grid (IPTV style) */
    .categories-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;align-items:start}
    @media (max-width:1280px){.categories-grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:1024px){.categories-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.categories-grid{grid-template-columns:repeat(2,1fr)}}

    .cat-card{background:var(--glass);border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .cat-symbol{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(109,40,217,0.18),rgba(147,51,234,0.12));font-size:20px}
    .cat-meta .cat-title{font-weight:700}
    .cat-meta .cat-sub{color:var(--muted);font-size:13px}

    /* Channels grid */
    .channels-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    @media (max-width:1280px){.channels-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:1024px){.channels-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.channels-grid{grid-template-columns:repeat(1,1fr)}}

    .channel-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:10px;padding:10px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .channel-thumb{height:120px;border-radius:8px;background-size:cover;background-position:center;margin-bottom:10px}
    .channel-name{font-weight:700}

    /* Focus */
    
    .focusable:focus{outline:none}
    .focused{transform:scale(1.06);box-shadow:var(--focus-glow);transition:all .22s}

    /* Player fullscreen (true fullscreen) */
    #player-screen{position:fixed;inset:0;background:#000;display:none;z-index:9999}
    #player-screen.active{display:block}
    #player-screen-inner{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #video-player{width:100%;height:100%;object-fit:fill;background:#000}

    .player-overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none}
    .top-bar{padding:18px;display:flex;justify-content:space-between;align-items:center;pointer-events:auto}
    .channel-info{background:linear-gradient(90deg,rgba(17,11,29,0.45),rgba(17,11,29,0.28));padding:10px 14px;border-radius:10px;font-weight:700}
    #lag-indicator{padding:6px 10px;border-radius:8px;background:rgba(220,38,38,0.95);color:white;opacity:0;transition:opacity .25s}

    /* bottom info bar (EPG-like) */
    .bottom-bar{padding:12px 18px;display:flex;align-items:center;gap:12px;justify-content:space-between;pointer-events:auto}
    .prog-title{font-weight:700}
    .prog-sub{color:var(--muted);font-size:13px}
    .progress-track{height:6px;background:rgba(255,255,255,0.04);border-radius:6px;flex:1;margin-left:14px;margin-right:14px;overflow:hidden}
    .progress-fill{height:100%;width:40%;background:linear-gradient(90deg,var(--violet-1),var(--violet-2))}

    /* hints */
    .hints{position:absolute;left:18px;bottom:18px;background:linear-gradient(90deg,rgba(17,11,29,0.45),rgba(17,11,29,0.28));padding:8px 10px;border-radius:8px;font-size:13px;color:var(--muted);pointer-events:auto}

    /* Loading overlay */
    #loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:linear-gradient(180deg,rgba(0,0,0,0.65),rgba(0,0,0,0.35));backdrop-filter:blur(6px);z-index:10000;opacity:0;pointer-events:none;transition:opacity .32s}
    #loading-overlay.visible{opacity:1;pointer-events:auto}
    .spinner{width:84px;height:84px;border-radius:999px;border:6px solid rgba(255,255,255,0.06);border-top-color:var(--violet-1);animation:spin 1.1s linear infinite;box-shadow:0 12px 40px rgba(109,40,217,0.15)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-weight:700;letter-spacing:1px;color:white}
    .loading-sub{color:var(--muted);font-size:13px}

    /* ping badge (only during loading) */
    #ping-badge{position:absolute;top:18px;right:18px;background:rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-weight:700;opacity:0;transition:opacity .2s;pointer-events:none}

    /* overlay elements hidden by default in fullscreen */
    .channel-info, .bottom-bar, #lag-indicator, #player-log{opacity:0;pointer-events:none;transition:opacity .25s}

    /* when overlay is visible */
    .overlay-visible .channel-info, .overlay-visible .bottom-bar, .overlay-visible #ping-badge, .overlay-visible #lag-indicator, .overlay-visible #player-log{opacity:1;pointer-events:auto}


    /* small responsive tweaks */
    @media (max-width:640px){ .brand-title{font-size:1.2rem;letter-spacing:4px} .logo-wrap{width:180px;height:180px} .spinner{width:64px;height:64px} .categories-grid{grid-template-columns:repeat(2,1fr)} .channels-grid{grid-template-columns:repeat(1,1fr)} }
  </style>
</head>
<body>
  <div id="app">
    <div class="bg-abstract" aria-hidden="true">
      <div class="blob b1"></div>
      <div class="blob b2"></div>
    </div>

    <main>
      <!-- HOME -->
      <section id="home-screen" class="home-wrap screen active" aria-hidden="false">
        <div class="logo-wrap" id="eye-container">
          <svg class="logo-svg" viewBox="0 0 240 240" aria-label="IPVIEW logo" role="img">
            <defs>
              <radialGradient id="irisGrad" cx="35%" cy="30%">
                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.06"/>
                <stop offset="25%" stop-color="#7c3aed"/>
                <stop offset="100%" stop-color="#3b0766"/>
              </radialGradient>
            </defs>
            <g transform="translate(120,120)">
              <path d="M-100,0 C-60,-68 60,-68 100,0 C60,68 -60,68 -100,0 Z" fill="rgba(255,255,255,0.02)" />
              <circle class="iris" r="46" fill="url(#irisGrad)" />
              <g class="pupil" id="pupilGroup"><circle r="18" fill="#050003"/><circle r="7" fill="#fff" opacity="0.06" transform="translate(-5,-5)"/></g>
              <path d="M-40,-18 C-10,-40 30,-32 54,-16 C36,-8 10,2 -20,6 C-36,4 -52,-2 -40,-18 Z" fill="#fff" opacity="0.06" />
            </g>
          </svg>
        </div>

        <div class="brand-title">IPVIEW</div>

        <button id="start-btn" class="start-btn focusable" aria-label="Assistir TV ao vivo">ASSISTIR TV AO VIVO</button>

        <div id="home-powered" class="home-footer">Powered by Levi</div>
      </section>

      <!-- CATEGORIES -->
      <section id="categories-screen" class="screen" aria-hidden="true">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-3xl font-extrabold">Categorias</h2>
            <p class="text-sm text-[rgba(255,255,255,0.36)]">Use as setas para navegar ‚Äî Enter para abrir</p>
          </div>
          <div>
            <button id="cat-back" class="start-btn focusable">‚Üê Voltar</button>
          </div>
        </div>
        <div id="categories-grid" class="categories-grid" role="list"></div>
      </section>

      <!-- CHANNELS -->
      <section id="channels-screen" class="screen" aria-hidden="true">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 id="channels-title" class="text-2xl font-bold"></h2>
          </div>
          <div>
            <button id="chan-back" class="start-btn focusable">‚Üê Categorias</button>
          </div>
        </div>
        <div id="channels-grid" class="channels-grid" role="list"></div>
      </section>

      <!-- PLAYER -->
      <section id="player-screen" class="screen" aria-hidden="true">
        <div id="player-screen-inner">
          <video id="video-player" playsinline webkit-playsinline muted></video>

          <div id="ping-badge" aria-hidden="true">Ping: ‚Äî ms</div>

          <div class="player-overlay">
            <div class="top-bar">
              <div id="channel-info" class="channel-info">‚Äî</div>
              <div id="lag-indicator">LAG</div>
            </div>

            <div class="bottom-bar">
              <div style="display:flex;align-items:center;gap:12px;">
                <div class="prog-title" id="prog-title">Ao Vivo</div>
                <div class="prog-sub" id="prog-sub">Sem dados EPG</div>
              </div>
              <div style="display:flex;align-items:center;gap:12px;width:60%;">
                <div class="progress-track"><div class="progress-fill" id="prog-fill"></div></div>
                <div class="prog-time" id="prog-time">00:00</div>
              </div>
            </div>
          </div>

          <!-- Loading overlay -->
          <div id="loading-overlay">
            <div class="spinner" aria-hidden="true"></div>
            <div class="loading-text" id="loading-text">CARREGANDO‚Ä¶</div>
            <div class="loading-sub" id="loading-sub">Aguarde enquanto o canal √© preparado</div>
          </div>

          <div class="hints">‚Üê/‚Üí trocar ‚Ä¢ ‚Üë voltar ‚Ä¢ ‚Üì info/desmutar ‚Ä¢ F favorita</div>

          <!-- Error log (visible small console) -->
          <div id="player-log" style="display:none;position:absolute;left:18px;bottom:72px;background:rgba(0,0,0,0.55);padding:8px 10px;border-radius:8px;font-size:12px;color:rgba(255,255,255,0.85);max-width:40%;opacity:0.95">Pronto</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // CHANNEL_DATA (exact as provided by user)
    const CHANNEL_DATA = {
        "esportes": [
            { "nome": "Premiere 1", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/d485d118d525ae4326aa31371f5dfcef/premiere.m3u8" },
            { "nome": "Premiere 2", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/aa1f6257eeb308e3e6677bae5fb7f1c8/premiere2.m3u8" }
        ],
        "noticias": [
            { "nome": "Record News", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/3728ae10c1a4f5b4a394d9771ec12db2/record.m3u8" }
        ],
        "infantil": [
            { "nome": "Cartoon Network", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/f67e159151a581847c31a461034c795a/cartoonnetwork.m3u8" },
            { "nome": "Nickelodeon", "url": "https://d1muf25xa11so8hp22.s27-usa-cloudfront-net.online/token/528246d1903b4743bca33088eedc800f/nickelodeon.m3u8" }
        ],
        "filmes_e_series": [
            { "nome": "Telecine Premium", "url": "https://placehold.co/400x225/ba55d3/ffffff?text=Telecine" },
            { "nome": "HBO HD", "url": "https://placehold.co/400x225/4b0082/ffffff?text=HBO" }
        ],
        "variedades": [
            { "nome": "Multishow", "url": "https://placehold.co/400x225/daa520/000000?text=Multi" },
            { "nome": "GNT", "url": "https://placehold.co/400x225/808080/ffffff?text=GNT" }
        ]
    };

    // State
    const state = {
      view: 'home', // home | categories | channels | player
      currentCategory: null,
      channelIndex: 0,
      hls: null,
      focusables: [],
      focusIndex: 0,
      favorites: {},
      _overlayTimer: null,
      _progInterval: null
    };

    // Refs
    const REFS = {
      home: document.getElementById('home-screen'),
      startBtn: document.getElementById('start-btn'),
      homePowered: document.getElementById('home-powered'),
      categories: document.getElementById('categories-screen'),
      categoriesGrid: document.getElementById('categories-grid'),
      catBack: document.getElementById('cat-back'),
      channels: document.getElementById('channels-screen'),
      channelsGrid: document.getElementById('channels-grid'),
      channelsTitle: document.getElementById('channels-title'),
      chanBack: document.getElementById('chan-back'),
      playerScreen: document.getElementById('player-screen'),
      playerInner: document.getElementById('player-screen-inner'),
      video: document.getElementById('video-player'),
      channelInfo: document.getElementById('channel-info'),
      lag: document.getElementById('lag-indicator'),
      loadingOverlay: document.getElementById('loading-overlay'),
      loadingText: document.getElementById('loading-text'),
      loadingSub: document.getElementById('loading-sub'),
      ping: document.getElementById('ping-badge'),
      playerLog: document.getElementById('player-log'),
      progFill: document.getElementById('prog-fill'),
      progTime: document.getElementById('prog-time'),
      progTitle: document.getElementById('prog-title'),
      progSub: document.getElementById('prog-sub')
    };

    /* ---------- Utilities - Views ---------- */
    function showView(name){
      ['home-screen','categories-screen','channels-screen','player-screen'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('active'); el.style.display = 'none'; el.setAttribute('aria-hidden','true');
      });
      const target = document.getElementById((name.endsWith('-screen')? name : name + '-screen'));
      if(target){ target.classList.add('active'); target.style.display = 'block'; target.setAttribute('aria-hidden','false'); }
      state.view = name.replace('-screen','');
      REFS.homePowered.style.display = (name==='home' || name==='home-screen') ? 'block' : 'none';
      rebuildFocusables();
    }

    /* ---------- Focusables Helpers ---------- */
    function rebuildFocusables(){
      // include only visible .focusable elements and ensure tabindex is present
      state.focusables = Array.from(document.querySelectorAll('.focusable')).filter(el => isVisible(el));
      state.focusables.forEach(el=>{ if(!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0'); });
      if(state.focusables.length === 0) { state.focusIndex = 0; return; }
      if(state.focusIndex >= state.focusables.length) state.focusIndex = 0;
      applyFocus();
    }
    function isVisible(el){ return !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length) && getComputedStyle(el).visibility !== 'hidden'; }
    function applyFocus(){ document.querySelectorAll('.focused').forEach(x=>x.classList.remove('focused')); const el = state.focusables[state.focusIndex]; if(el){ el.classList.add('focused'); try{el.focus();}catch(e){} el.scrollIntoView({behavior:'smooth',block:'center',inline:'center'}); } }

    // Grid-aware focus movement: left/right + up/down (uses computed columns of nearest grid)
    function getGridColumns(container){ try{ const cs = getComputedStyle(container); const template = cs.gridTemplateColumns || ''; const cols = (template.match(/\bauto\b|\bminmax\b|[^\s]+/g) || template.split(' ').filter(Boolean)).length; return Math.max(1, cols); }catch(e){ return 1; } }
    function focusMove(direction){
      if(state.focusables.length===0) return;
      // direction: 'left'|'right'|'up'|'down'|'next'|'prev'
      const cur = state.focusIndex;
      let next = cur;
      if(direction === 'next' || direction === 'right') next = Math.min(state.focusables.length-1, cur + 1);
      else if(direction === 'prev' || direction === 'left') next = Math.max(0, cur - 1);
      else if(direction === 'up' || direction === 'down'){
        // try to detect parent grid to compute columns
        const el = state.focusables[cur];
        const grid = el ? el.closest('.categories-grid, .channels-grid') : null;
        const cols = grid ? getGridColumns(grid) : 4;
        next = direction === 'up' ? Math.max(0, cur - cols) : Math.min(state.focusables.length-1, cur + cols);
      }
      state.focusIndex = next; applyFocus();
    }

    /* ---------- Category metadata ---------- */
    const CAT_META = { esportes:{sym:'‚öΩ',desc:'Esportes ao vivo'}, noticias:{sym:'üì∞',desc:'Not√≠cias 24h'}, infantil:{sym:'üß∏',desc:'Programa√ß√£o infantil'}, filmes_e_series:{sym:'üé¨',desc:'Filmes e s√©ries'}, variedades:{sym:'‚ú®',desc:'Entretenimento'} };

    /* ---------- Render categories & channels (fixed) ---------- */
    function renderCategories(){
      REFS.categoriesGrid.innerHTML = '';
      Object.keys(CHANNEL_DATA).forEach(key => {
        const meta = CAT_META[key] || {sym:'üì∫',desc:''};
        const card = document.createElement('button');
        card.className = 'focusable cat-card';
        card.setAttribute('data-key', key);
        card.setAttribute('role','button');
        card.innerHTML = `<div class='cat-symbol'>${meta.sym}</div><div class='cat-meta'><div class='cat-title'>${key.replace(/_/g,' ').toUpperCase()}</div><div class='cat-sub'>${meta.desc}</div></div>`;
        card.addEventListener('click', ()=> openChannels(key));
        REFS.categoriesGrid.appendChild(card);
      });
      rebuildFocusables();
    }

    function openChannels(categoryKey){
      state.currentCategory = categoryKey;
      REFS.channelsTitle.textContent = categoryKey.replace(/_/g,' ').toUpperCase();
      REFS.channelsGrid.innerHTML = '';
      const list = CHANNEL_DATA[categoryKey] || [];
      list.forEach((ch, idx)=>{
        const card = document.createElement('button');
        card.className = 'focusable channel-card';
        card.setAttribute('data-idx', idx);
        card.setAttribute('role','button');
        const thumb = ch.url && ch.url.startsWith('https://placehold.co') ? ch.url : `https://placehold.co/600x340/0f0222/ffffff?text=${encodeURIComponent(ch.nome)}`;
        card.innerHTML = `<div class='channel-thumb' style="background-image:url('${thumb}')"></div><div class='channel-name'>${ch.nome}</div>`;
        card.addEventListener('click', ()=> openPlayer(idx));
        REFS.channelsGrid.appendChild(card);
      });
      // Directly show channels view (avoid double show hack)
      showView('channels');
    }

    /* ---------- PLAYER: loading UI + ping + HLS ---------- */
    async function openPlayer(idx){
      state.channelIndex = idx;
      await playChannelAtIndex(idx);
      // request fullscreen for immersive TV-like behavior (best-effort)
      try{ if(document.fullscreenEnabled){ REFS.playerScreen.requestFullscreen().catch(()=>{}); } }catch(e){}
      showView('player');
    }

    function log(msg){
      console.log('[IPVIEW]', msg);
      try{ if(REFS.playerLog) REFS.playerLog.style.display = 'none'; }catch(e){}
    }

    async function playChannelAtIndex(idx){
      const list = CHANNEL_DATA[state.currentCategory] || [];
      if(idx < 0 || idx >= list.length) return;
      const ch = list[idx];
      REFS.channelInfo.textContent = ch.nome || '‚Äî';

      // prepare loading overlay
      REFS.loadingOverlay.classList.add('visible');
      REFS.loadingText.textContent = 'CARREGANDO‚Ä¶';
      REFS.loadingSub.textContent = 'Aguarde enquanto o canal √© preparado';
      REFS.ping.textContent = 'Ping: ‚Äî ms';
      REFS.ping.style.opacity = 1; // show ping only during load
      REFS.lag.style.opacity = 0;

      const url = ch.url;
      const video = REFS.video;

      // cleanup previous HLS
      try{ if(state.hls){ state.hls.destroy(); state.hls = null; } }catch(e){ }
      video.removeAttribute('src'); video.load();

      // measure ping (best-effort, tolerate CORS issues)
      measurePing(url).then(ms=>{ REFS.ping.textContent = ms>0? `Ping: ${ms} ms` : 'Ping: -'; }).catch(()=>{ REFS.ping.textContent = 'Ping: -'; });

      // configure video for autoplay compatibility
      try{ video.crossOrigin = 'anonymous'; }catch(e){}
      video.playsInline = true; video.muted = true; // keep muted to allow autoplay; user can unmute via ‚Üì
      video.removeAttribute('controls');

      // show program UI quickly
      REFS.progTitle.textContent = ch.nome;
      REFS.progSub.textContent = 'Ao Vivo';
      REFS.progTime.textContent = new Date().toLocaleTimeString();
      REFS.progFill.style.width = '18%';

      // HLS flow
      if(window.Hls && Hls.isSupported() && typeof url === 'string' && url.endsWith('.m3u8')){
        const hls = new Hls({maxBufferLength:30,maxMaxBufferLength:60,autoStartLoad:true});
        state.hls = hls;
        hls.attachMedia(video);

        let manifestLoaded = false;
        hls.on(Hls.Events.MEDIA_ATTACHED, ()=> { hls.loadSource(url); });

        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
          manifestLoaded = true;
          video.play().then(()=>{
            REFS.loadingText.textContent = 'CARREGADO';
            setTimeout(()=>{
              REFS.loadingOverlay.classList.remove('visible');
              REFS.ping.style.opacity = 0;
            }, 700);
          }).catch(err=>{ log('play blocked: '+ err); REFS.loadingText.textContent = 'TENTANDO‚Ä¶'; });
        });

        hls.on(Hls.Events.ERROR, (event, data)=>{
          log('HLS ERROR: ' + JSON.stringify(data));
          REFS.lag.textContent = 'ERROR';
          showPlayerOverlayTemp();
          REFS.loadingText.textContent = 'ERRO AO CARREGAR';
          // fallback to direct src
          try{ video.src = url; video.load(); video.play().catch(()=>{}); }catch(e){}
          REFS.ping.style.opacity = 0;
        });

        hls.on(Hls.Events.BUFFER_STALLED, ()=>{ REFS.lag.textContent = 'BUFFER STALLED'; REFS.loadingText.textContent = 'CARREGANDO‚Ä¶'; showPlayerOverlayTemp(); });
        hls.on(Hls.Events.BUFFER_EMPTY, ()=>{ REFS.lag.textContent = 'BUFFER EMPTY'; REFS.loadingText.textContent = 'CARREGANDO‚Ä¶'; showPlayerOverlayTemp(); });
        hls.on(Hls.Events.PLAYING, ()=>{ REFS.lag.style.opacity = 0; REFS.loadingText.textContent = 'CARREGADO'; setTimeout(()=> REFS.loadingOverlay.classList.remove('visible'), 700); REFS.ping.style.opacity = 0; });

      } else {
        // fallback to direct src (images/placeholders)
        video.src = url;
        video.load();
        video.play().then(()=>{ REFS.loadingText.textContent = 'CARREGADO'; setTimeout(()=> REFS.loadingOverlay.classList.remove('visible'),700); REFS.ping.style.opacity = 0; }).catch(err=>{ log('play error: '+err); REFS.loadingText.textContent = 'ERRO AO CARREGAR'; REFS.ping.style.opacity = 0; });
      }

      // if paused by browser, try resume on key press; keep muted until user unmutes
      video.onpause = ()=>{ if(state.view === 'player'){ setTimeout(()=>{ try{ video.play().catch(()=>{}); }catch(e){} },200); } };

      // helper to show player overlay temporarily
      function showPlayerOverlayTemp(){
        try{
          const container = document.getElementById('player-screen-inner');
          container.classList.add('overlay-visible');
          if(REFS.loadingOverlay.classList.contains('visible')) REFS.ping.style.opacity = 1;
          clearTimeout(state._overlayTimer);
          state._overlayTimer = setTimeout(hidePlayerOverlay, 3000);
        }catch(e){}
      }
      function hidePlayerOverlay(){ try{ const container = document.getElementById('player-screen-inner'); container.classList.remove('overlay-visible'); REFS.ping.style.opacity = 0; }catch(e){} }
      hidePlayerOverlay();

      // when starting playback, ensure overlay is hidden
      video.addEventListener('playing', ()=>{ REFS.loadingText.textContent = 'CARREGADO'; setTimeout(()=> REFS.loadingOverlay.classList.remove('visible'),700); REFS.ping.style.opacity = 0; setTimeout(()=> hidePlayerOverlay(), 800); });

      // small updater for prog time/progress
      try{ clearInterval(state._progInterval); }catch(e){}
      state._progInterval = setInterval(()=>{
        REFS.progTime.textContent = new Date().toLocaleTimeString();
        const cur = parseFloat(REFS.progFill.style.width) || 0;
        REFS.progFill.style.width = Math.min(100, cur + 0.15) + '%';
      }, 3000);
    }

    // measure ping by fetching resource (best-effort, no strict reliance on CORS)
    async function measurePing(url){
      try{
        const start = performance.now();
        // try a small HEAD; may fail due to CORS ‚Äî that's fine
        await fetch(url, {method:'HEAD', mode:'no-cors'});
        return Math.max(1, Math.round(performance.now()-start));
      }catch(e){
        try{
          const start = performance.now();
          await fetch('https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png', {method:'HEAD', mode:'no-cors'});
          return Math.max(10, Math.round(performance.now()-start));
        }catch(err){
          return -1;
        }
      }
    }

    /* ---------- Channel navigation ---------- */
    function prevChannel(){ const list = CHANNEL_DATA[state.currentCategory]||[]; state.channelIndex = (state.channelIndex -1 + list.length)%list.length; playChannelAtIndex(state.channelIndex); }
    function nextChannel(){ const list = CHANNEL_DATA[state.currentCategory]||[]; state.channelIndex = (state.channelIndex +1)%list.length; playChannelAtIndex(state.channelIndex); }
    function exitToChannels(){ try{ if(state.hls){ state.hls.destroy(); state.hls = null; } }catch(e){} try{ REFS.video.pause(); }catch(e){} REFS.video.removeAttribute('src'); REFS.video.load(); try{ document.exitFullscreen().catch(()=>{}); }catch(e){} showView('channels'); }

    /* ---------- Keyboard handling (TV-style) ---------- */
    window.addEventListener('keydown', (e)=>{
      // when in player view
      if(state.view === 'player'){
        if(e.key === 'ArrowLeft'){ e.preventDefault(); prevChannel(); }
        else if(e.key === 'ArrowRight'){ e.preventDefault(); nextChannel(); }
        else if(e.key === 'ArrowUp'){ e.preventDefault(); exitToChannels(); }
        else if(e.key === 'ArrowDown'){ e.preventDefault(); // toggle overlay info and unmute/mute
          const vid = REFS.video;
          vid.muted = !vid.muted;
          const inner = REFS.playerInner;
          if(vid.muted){ inner.classList.add('overlay-visible'); REFS.loadingText.textContent = 'MUTED'; }
          else { inner.classList.add('overlay-visible'); REFS.loadingText.textContent = 'UNMUTED'; }
          clearTimeout(state._overlayTimer);
          state._overlayTimer = setTimeout(()=>{ inner.classList.remove('overlay-visible'); REFS.loadingText.textContent = ''; }, 900);
        }
        else if(e.key === 'f' || e.key === 'F'){ e.preventDefault(); // toggle favorite
          const ch = CHANNEL_DATA[state.currentCategory][state.channelIndex];
          const key = state.currentCategory + '::' + ch.nome;
          state.favorites[key] = !state.favorites[key];
          REFS.playerLog.style.display = 'block'; REFS.playerLog.textContent = state.favorites[key] ? 'Favorito ‚úÖ' : 'Removido de Favoritos';
          setTimeout(()=> REFS.playerLog.style.display = 'none', 1200);
        }
        else if(e.key === 'Escape' || e.key === 'Backspace'){ e.preventDefault(); exitToChannels(); }
        return;
      }

      // not player: navigate focusables
      if(e.key === 'ArrowDown'){ e.preventDefault(); focusMove('down'); }
      else if(e.key === 'ArrowUp'){ e.preventDefault(); focusMove('up'); }
      else if(e.key === 'ArrowLeft'){ e.preventDefault(); focusMove('left'); }
      else if(e.key === 'ArrowRight'){ e.preventDefault(); focusMove('right'); }
      else if(e.key === 'Enter'){ e.preventDefault(); const el = state.focusables[state.focusIndex]; if(el) el.click(); }
      else if(e.key === 'Escape' || e.key === 'Backspace'){
        if(state.view === 'channels') showView('categories'); else if(state.view === 'categories') showView('home');
      }
    });

    // click & hover to set focus (robust to inner elements)
    document.addEventListener('click', (ev)=>{ const btn = ev.target.closest && ev.target.closest('.focusable'); if(btn){ rebuildFocusables(); const idx = state.focusables.indexOf(btn); if(idx>=0){ state.focusIndex = idx; applyFocus(); } } }, true);
    document.body.addEventListener('mouseover', (e)=>{ const btn = e.target.closest && e.target.closest('.focusable'); if(btn){ rebuildFocusables(); const idx = state.focusables.indexOf(btn); if(idx>=0){ state.focusIndex = idx; applyFocus(); } } });

    // Buttons
    REFS.startBtn.addEventListener('click', ()=>{ renderCategories(); showView('categories'); });
    REFS.catBack.addEventListener('click', ()=> showView('home'));
    REFS.chanBack.addEventListener('click', ()=> showView('categories'));

    // subtle pupil motion (less sensitive)
    setInterval(()=>{ const g = document.getElementById('pupilGroup'); if(!g) return; const dx = (Math.random()*6 - 3) * 0.25; const dy = (Math.random()*4 - 2) * 0.25; g.style.transform = `translate(${dx}px,${dy}px)`; }, 2600 + Math.random()*2400);

    // initial render categories & view
    renderCategories();
    showView('home');

    // build initial focusables after load
    setTimeout(()=> rebuildFocusables(), 300);
  </script>
</body>
</html>
