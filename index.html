<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta tags para App Web (PWA) para ajudar a esconder UI do navegador -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>iView - IPTV Live</title>
    <!-- Inclui Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Hls.js para reprodução fluida de m3u8 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* Variáveis de Cores e Estilo */
        :root {
            --dark-bg: #121212;
            --main-bg: #1c1c1c;
            --highlight-color: #9333ea;
            --focus-bg: #5a2484;
            --text-light: #e0e0e0;
            --text-dark: #a0a0a0;
        }

        /* Configuração do Tailwind */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': 'var(--dark-bg)',
                        'secondary-dark': 'var(--main-bg)',
                        'accent-violet': 'var(--highlight-color)',
                        'focus-bg': 'var(--focus-bg)',
                        'text-light': 'var(--text-light)',
                        'text-dark': 'var(--text-dark)',
                    },
                }
            }
        }

        /* Estilos Globais */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #000000;
            color: var(--text-light);
            min-height: 100vh;
            min-height: 100dvh; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 0;
            /* Previne seleção de texto e zoom acidental */
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Container Principal */
        .iptv-container {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            height: 90dvh; 
            min-height: 500px;
            background-color: var(--main-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 50px rgba(147, 51, 234, 0.6);
            display: flex;
            gap: 20px;
            transition: all 0.5s ease-in-out;
            position: relative;
        }

        /* Foco e Seleção */
        .category-item.focus,
        .channel-item.focus {
            outline: none;
            background-color: var(--focus-bg) !important;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.9);
            border: 1px solid var(--highlight-color);
        }

        /* --- MODO FULL SCREEN --- */
        .iptv-container.full-player-mode,
        :fullscreen .iptv-container,
        :-webkit-full-screen .iptv-container {
            width: 100vw !important;
            height: 100vh !important;
            height: 100dvh !important;
            border-radius: 0 !important;
            padding: 0 !important;
            box-shadow: none !important;
            background-color: black !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 99999 !important;
            max-width: none !important;
        }

        .iptv-container.full-player-mode .sidebar,
        .iptv-container.full-player-mode .channel-list-wrapper {
            display: none !important;
        }

        .iptv-container.full-player-mode .main-content {
            width: 100%;
            height: 100%;
            padding: 0;
        }
        
        .iptv-container.full-player-mode .video-player {
            border-radius: 0;
            border: none;
            width: 100%;
            height: 100%;
        }

        /* Sidebar (Categorias) */
        .sidebar {
            width: 180px;
            flex-shrink: 0;
            padding-right: 15px;
            border-right: 1px solid var(--dark-bg);
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 100%;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar, .channel-list::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb, .channel-list::-webkit-scrollbar-thumb { background-color: var(--focus-bg); border-radius: 3px; }

        .logo { margin-bottom: 25px; padding-left: 10px; }
        .logo i { font-size: 30px; color: var(--highlight-color); margin-right: 8px; }
        .logo h1 { font-size: 24px; font-weight: 700; margin: 0; }

        .category-item {
            padding: 12px 10px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 10px; /* Espaço entre ícone e texto */
        }
        .category-item i {
            width: 20px;
            text-align: center;
            color: var(--text-dark);
        }
        .category-item.selected, .category-item:hover {
            background-color: rgba(147, 51, 234, 0.2);
            color: var(--text-light);
        }
        .category-item.selected i { color: var(--highlight-color); }

        /* Lista de Canais */
        .channel-list-wrapper {
            width: 280px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--dark-bg);
            padding-right: 15px;
        }

        .channel-list {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 100%;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 10px 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .channel-number {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-bg);
            background-color: var(--highlight-color);
            padding: 3px 7px;
            border-radius: 3px;
            margin-right: 10px;
            min-width: 35px;
            text-align: center;
        }

        /* Player Area */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .video-player {
            flex-grow: 1;
            background-color: #000;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--dark-bg);
            transition: all 0.5s ease-in-out;
            cursor: pointer; /* Cursor muda para indicar interatividade */
            width: 100%;
            height: 100%;
        }
        
        .video-wrapper {
            width: 100%;
            height: 100%;
            background: black;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            /* No desktop 'contain' é melhor para não cortar, mas no mobile full o usuário pediu para preencher tudo */
            object-fit: contain; 
            display: block;
        }
        
        /* Quando estiver em Full Player Mode, força preenchimento total (zoom/crop) se desejado */
        .iptv-container.full-player-mode .video-wrapper video {
            object-fit: cover; /* Preenche a tela toda, cortando as bordas se necessário */
        }

        /* --- OVERLAY E CONTROLES --- */
        /* Base styles para todos os elementos de overlay */
        .overlay-element {
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none; /* Permite clicar através quando invisível */
        }
        
        /* Quando a classe 'visible' é adicionada via JS (interação) */
        .overlay-element.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* O Player Overlay (barra inferior) */
        .player-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            padding: 20px 20px 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 25;
        }
        
        /* Info Topo (Nome do canal no canto superior) */
        .channel-info-player {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            z-index: 20;
            backdrop-filter: blur(4px);
        }

        .ping-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 30;
            display: none;
        }
        .ping-indicator.active { display: block; }

        .control-button {
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
            padding: 10px;
        }
        .control-button:hover { color: var(--highlight-color); transform: scale(1.1); }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--highlight-color);
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- RESPONSIVIDADE AVANÇADA --- */

        /* Tablet e Mobile (Modo Retrato) */
        @media (max-width: 1024px) {
            .iptv-container {
                flex-direction: column;
                height: 100dvh;
                width: 100%;
                padding: 0;
                border-radius: 0;
            }

            .main-content {
                order: 1; /* Player no topo */
                flex-grow: 0;
                height: 35dvh; /* Altura fixa do player na vertical */
                width: 100%;
            }

            .video-player {
                border: none;
            }

            /* Sidebar vira Menu Horizontal de Ícones */
            .sidebar {
                order: 2;
                width: 100%;
                height: auto;
                min-height: 60px;
                flex-direction: row;
                border-right: none;
                border-bottom: 1px solid var(--dark-bg);
                padding: 0 10px;
                overflow-x: auto;
                overflow-y: hidden;
                align-items: center;
                background: #151515;
                gap: 5px;
            }
            
            .logo { display: none; } 

            .category-item {
                flex-direction: column; /* Ícone em cima, texto embaixo (ou escondido) */
                padding: 8px 12px;
                min-width: 60px;
                justify-content: center;
                gap: 4px;
                border-radius: 6px;
                text-align: center;
            }
            
            .category-item i {
                width: auto;
                font-size: 18px;
                margin-bottom: 0;
            }

            /* Esconde o texto da categoria em telas muito pequenas para caber mais ícones */
            .category-item span {
                font-size: 10px;
            }

            .channel-list-wrapper {
                order: 3;
                width: 100%;
                flex-grow: 1;
                border-right: none;
                padding: 10px;
                overflow-y: auto;
                padding-bottom: 20px;
            }
        }

        /* Phones Pequenos */
        @media (max-width: 640px) {
            .category-item span { display: none; } /* Só ícones no mobile pequeno */
            .category-item { min-width: 50px; padding: 12px 0; }
            .category-item i { font-size: 20px; color: var(--text-dark); }
            .category-item.selected i { color: var(--highlight-color); }
        }

        /* Landscape em Mobile (Girar tela) */
        @media (max-height: 500px) and (orientation: landscape) {
            .iptv-container:not(.full-player-mode) {
                flex-direction: row;
            }
            .sidebar { width: 70px; display: flex; flex-direction: column; padding-top: 10px; }
            .category-item { flex-direction: column; padding: 10px 0; }
            .category-item span { display: none; }
            .logo { display: none; }
            .channel-list-wrapper { width: 220px; }
            .main-content { height: 100%; }
        }
    </style>
</head>
<body>

    <div class="iptv-container" id="iptv-container">
        
        <!-- SIDEBAR (Navegação com Ícones) -->
        <div class="sidebar" data-section="categories">
            <div class="logo">
                <i class="fas fa-eye"></i>
                <h1>iView</h1>
            </div>

            <div class="category-item focus" data-category="ESPORTES">
                <i class="fas fa-futbol"></i> <span>ESPORTES</span>
            </div> 
            <div class="category-item" data-category="FILMES">
                <i class="fas fa-film"></i> <span>FILMES</span>
            </div>
            <div class="category-item" data-category="SÉRIES">
                <i class="fas fa-tv"></i> <span>SÉRIES</span>
            </div>
            <div class="category-item" data-category="AO VIVO">
                <i class="fas fa-broadcast-tower"></i> <span>AO VIVO</span>
            </div>
            <div class="category-item" data-category="NOTÍCIAS">
                <i class="fas fa-newspaper"></i> <span>NOTÍCIAS</span>
            </div>
            <div class="category-item" data-category="DOCUMENTÁRIOS">
                <i class="fas fa-globe-americas"></i> <span>DOCS</span>
            </div>
            <div class="category-item" data-category="INFANTIL">
                <i class="fas fa-child"></i> <span>KIDS</span>
            </div>
            <div class="category-item" data-category="CONFIGURAÇÕES">
                <i class="fas fa-cog"></i> <span>CONFIG</span>
            </div>
        </div>

        <!-- CONTEÚDO -->
        <div class="main-content">
            <!-- PLAYER -->
            <div class="video-player" data-section="player" id="video-player-container">
                <div class="video-wrapper">
                    <!-- Video Element -->
                    <video id="iptv-video" autoplay playsinline x-webkit-airplay="allow"></video>
                </div>
                
                <!-- GRUPO DE OVERLAY (Elementos que somem após inatividade) -->
                <div id="ui-overlay-group">
                    <!-- Info Topo -->
                    <div class="channel-info-player overlay-element" id="player-info-display">
                        <i class="fas fa-satellite-dish text-red-500 mr-2 animate-pulse"></i>
                        <span id="player-channel-text">AGUARDANDO SELEÇÃO</span>
                    </div>

                    <!-- Ping -->
                    <div class="ping-indicator overlay-element" id="ping-display">Potência do Sinal: --ms</div>

                    <!-- Controles Overlay -->
                    <div class="player-overlay overlay-element">
                        <div class="text-left">
                            <div class="text-lg font-bold text-white" id="overlay-channel-name">--</div>
                            <div class="text-xs text-accent-violet uppercase">Ao Vivo • HD</div>
                        </div>
                        
                        <div class="flex items-center gap-6">
                            <i class="fas fa-volume-up control-button text-2xl" data-control="volume" id="volume-btn"></i>
                            <i class="fas fa-expand control-button text-2xl" data-control="fullscreen" id="fullscreen-btn"></i>
                        </div>
                    </div>
                </div>

                <!-- Loading (Fica sempre visível quando necessário) -->
                <div class="absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center z-10 hidden" id="player-loading-screen">
                    <div class="loading-spinner"></div>
                    <div class="text-lg font-semibold text-white text-center">Sintonizando...</div>
                    <div class="text-xs text-gray-400 mt-2">Estabilizando conexão</div>
                </div>
                
                <!-- Erro -->
                <div class="absolute inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center z-10 hidden" id="player-error-screen">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-3"></i>
                    <div class="text-lg text-white">Sinal Indisponível</div>
                    <div class="text-sm text-gray-500 mt-2">Tente outro canal</div>
                </div>
            </div>
        </div>
        
        <!-- LISTA DE CANAIS -->
        <div class="channel-list-wrapper">
            <div class="channel-list" data-section="channels" id="channel-list">
                <!-- JS Preenche -->
            </div>
        </div>

    </div>

    <script>
        // --- DADOS ---
        const MOCK_CHANNELS = {
            "ESPORTES": [
                { num: 101, name: "PREMIERE CLUBES", url: "https://d1muf25xa11so8hp23.s27-usa-cloudfront-net.online/token/60f73ef0f9ad2fc60e7894739a496ba7/premiere.m3u8" },
                { num: 102, name: "ESPN BRASIL", url: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" },
                { num: 103, name: "SPORTV", url: "" },
                { num: 104, name: "COMBATE", url: "" },
            ],
            "FILMES": [
                { num: 201, name: "HBO", url: "" },
                { num: 202, name: "TELECINE", url: "" },
            ],
            "SÉRIES": [
                { num: 301, name: "WARNER", url: "" },
            ],
            "AO VIVO": [
                { num: 401, name: "GLOBO", url: "" },
                { num: 402, name: "CNN", url: "" },
            ],
            "NOTÍCIAS": [
                { num: 501, name: "NEWS GLOBAL", url: "" },
            ],
            "DOCUMENTÁRIOS": [
                { num: 601, name: "DISCOVERY", url: "" },
            ],
            "INFANTIL": [
                { num: 701, name: "CARTOON", url: "" },
            ],
            "CONFIGURAÇÕES": [
                { num: 901, name: "TESTE DE REDE", url: "" },
            ]
        };

        const elements = {
            container: document.getElementById('iptv-container'),
            channelListContainer: document.getElementById('channel-list'),
            videoPlayer: document.getElementById('iptv-video'),
            playerContainer: document.getElementById('video-player-container'),
            playerChannelText: document.getElementById('player-channel-text'),
            overlayChannelName: document.getElementById('overlay-channel-name'),
            loadingScreen: document.getElementById('player-loading-screen'),
            errorScreen: document.getElementById('player-error-screen'),
            pingDisplay: document.getElementById('ping-display'),
            overlayElements: document.querySelectorAll('.overlay-element'),
            categories: [], 
            channels: [], 
        };

        let currentSection = 'categories';
        let focusedIndex = 0;
        let isFullPlayerMode = false;
        let pingInterval = null;
        let hls = null; 
        let overlayTimer = null;

        // --- MODO TELA CHEIA REAL (Hide URL Bar) ---

        async function toggleFullPlayerMode(enable) {
            isFullPlayerMode = enable;
            
            if (enable) {
                // 1. UI Mode
                elements.container.classList.add('full-player-mode');
                setCurrentSection('player');

                // 2. Native Fullscreen (Crucial para esconder URL bar)
                try {
                    const elem = elements.container;
                    if (elem.requestFullscreen) await elem.requestFullscreen();
                    else if (elem.webkitRequestFullscreen) await elem.webkitRequestFullscreen();
                    else if (elem.msRequestFullscreen) await elem.msRequestFullscreen();
                    
                    // 3. Orientation Lock
                    if (screen.orientation && screen.orientation.lock) {
                        try { await screen.orientation.lock('landscape'); } catch (e) { console.log(e); }
                    }
                } catch (err) { console.log(err); }
                
                // Garante visibilidade inicial
                showOverlay();

            } else {
                elements.container.classList.remove('full-player-mode');
                
                if (document.fullscreenElement) {
                    try {
                        if (document.exitFullscreen) document.exitFullscreen();
                        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    } catch(e) {}
                }
                
                if (screen.orientation && screen.orientation.unlock) {
                    try { screen.orientation.unlock(); } catch(e){}
                }

                setTimeout(() => {
                    setCurrentSection('channels');
                    updateFocus();
                }, 200);
            }
        }

        document.addEventListener('fullscreenchange', checkFullscreenState);
        document.addEventListener('webkitfullscreenchange', checkFullscreenState);

        function checkFullscreenState() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (isFullPlayerMode) toggleFullPlayerMode(false);
            }
        }

        // --- OVERLAY AUTO-HIDE LOGIC ---

        function showOverlay() {
            elements.overlayElements.forEach(el => el.classList.add('visible'));
            resetOverlayTimer();
        }

        function hideOverlay() {
            // Só esconde se não estiver carregando
            if (elements.loadingScreen.classList.contains('hidden')) {
                elements.overlayElements.forEach(el => el.classList.remove('visible'));
            }
        }

        function resetOverlayTimer() {
            clearTimeout(overlayTimer);
            // Esconde após 3.5 segundos
            overlayTimer = setTimeout(hideOverlay, 3500);
        }

        // Interações que mostram o overlay
        elements.playerContainer.addEventListener('mousemove', showOverlay);
        elements.playerContainer.addEventListener('click', showOverlay);
        elements.playerContainer.addEventListener('touchstart', showOverlay);
        
        
        // --- RENDERIZAÇÃO ---

        function setCurrentSection(section) {
            if (currentSection !== section) {
                currentSection = section;
                focusedIndex = 0; 
                updateFocus(); 
            }
        }

        function renderChannels(categoryName) {
            const channels = MOCK_CHANNELS[categoryName] || [];
            elements.channelListContainer.innerHTML = '';
            elements.channels = [];
            
            if (categoryName === 'CONFIGURAÇÕES') {
                 elements.channelListContainer.innerHTML = `<div class="p-4 text-center text-accent-violet font-semibold text-sm">iView v3.0<br>Mobile Native Feel</div>`;
            } else if (channels.length === 0) {
                elements.channelListContainer.innerHTML = `<div class="p-4 text-center text-text-dark text-sm">Sem sinal.</div>`;
                return;
            }

            channels.forEach((channel, index) => {
                const item = document.createElement('div');
                item.className = 'channel-item transition duration-200';
                item.setAttribute('data-channel-index', index);
                item.setAttribute('data-channel-url', channel.url);
                item.setAttribute('data-channel-num', channel.num);
                item.innerHTML = `<span class="channel-number">${channel.num}</span><span class="channel-name truncate flex-1">${channel.name}</span>`;
                
                item.addEventListener('click', () => {
                    selectChannel(channel);
                });
                
                elements.channelListContainer.appendChild(item);
                elements.channels.push(item);
            });
        }
        
        // --- PLAYER LOGIC ---

        function startPingSimulation() {
            if (pingInterval) clearInterval(pingInterval);
            elements.pingDisplay.classList.add('active');
            pingInterval = setInterval(() => {
                const ms = Math.floor(Math.random() * (85 - 15 + 1) + 15);
                const color = ms > 60 ? '#ffcc00' : '#00ff00';
                elements.pingDisplay.style.color = color;
                elements.pingDisplay.textContent = `Sinal: ${ms}ms`;
            }, 1000);
        }

        function stopPingSimulation() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
            elements.pingDisplay.classList.remove('active');
        }

        function selectChannel(channelData) {
            const { num, name, url } = channelData;

            if (elements.overlayChannelName.textContent === name && !elements.videoPlayer.paused && elements.errorScreen.classList.contains('hidden')) {
                return; 
            }

            elements.playerChannelText.textContent = `${num} ${name}`;
            elements.overlayChannelName.textContent = name;
            elements.errorScreen.classList.add('hidden');
            elements.loadingScreen.classList.remove('hidden');
            
            // Garante que o overlay apareça ao mudar de canal
            showOverlay();
            startPingSimulation();

            // AUTO-AUDIO: Desmuta e toca
            elements.videoPlayer.muted = false;

            if (!url) {
                destroyHls();
                showError();
                return;
            }
            loadStream(url);
        }

        function loadStream(url) {
            const video = elements.videoPlayer;

            video.onplaying = () => {
                elements.loadingScreen.classList.add('hidden');
                stopPingSimulation();
                // Inicia timer para esconder overlay
                resetOverlayTimer();
            };
            
            video.onerror = () => {
                if(video.src) showError();
            };

            if (Hls.isSupported()) {
                destroyHls(); 
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    // Tenta reproduzir com som
                    video.muted = false;
                    video.play().catch(() => {
                        console.log("Autoplay c/ som bloqueado. Mutando...");
                        video.muted = true;
                        video.play();
                    });
                });
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                            case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                            default: destroyHls(); showError(); break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                destroyHls();
                video.src = url;
                video.addEventListener('loadedmetadata', function() {
                    video.muted = false;
                    video.play().catch(() => {
                        video.muted = true;
                        video.play();
                    });
                });
            } else {
                showError();
            }
        }

        function destroyHls() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
        }

        function showError() {
            stopPingSimulation();
            elements.loadingScreen.classList.add('hidden');
            elements.errorScreen.classList.remove('hidden');
        }

        // --- INPUT HANDLING ---

        function updateFocus() {
            document.querySelectorAll('.focus').forEach(el => el.classList.remove('focus'));
            
            let elementsToFocus = [];
            let focusedElement = null;

            if (currentSection === 'categories') elementsToFocus = elements.categories;
            else if (currentSection === 'channels') elementsToFocus = elements.channels;
            else if (currentSection === 'player') {
                // Foco no player
                return;
            }
            
            if (elementsToFocus.length > 0) {
                focusedIndex = Math.max(0, Math.min(focusedIndex, elementsToFocus.length - 1));
                focusedElement = elementsToFocus[focusedIndex];
                
                if (focusedElement) {
                    focusedElement.classList.add('focus');
                    focusedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                    
                    if (currentSection === 'categories') {
                        const categoryName = focusedElement.getAttribute('data-category');
                        renderChannels(categoryName);
                    }
                }
            }
        }

        // Teclado (TV/Desktop)
        document.addEventListener('keydown', (e) => {
            showOverlay(); // Qualquer tecla acorda o overlay

            const isCategorySection = currentSection === 'categories';
            const isChannelSection = currentSection === 'channels';
            
            if (isFullPlayerMode) {
                if (e.key === 'Escape' || e.key === 'Backspace') {
                    e.preventDefault();
                    toggleFullPlayerMode(false);
                }
                if (e.key === 'Enter') elements.videoPlayer.muted = !elements.videoPlayer.muted;
                return;
            }

            let handled = true;

            switch (e.key) {
                case 'ArrowUp':
                    focusedIndex = Math.max(0, focusedIndex - 1);
                    break;
                case 'ArrowDown':
                    const maxIndex = isCategorySection ? elements.categories.length - 1 : elements.channels.length - 1;
                    focusedIndex = Math.min(maxIndex, focusedIndex + 1);
                    break;
                case 'ArrowLeft':
                    if (isChannelSection) {
                        if (window.innerWidth <= 1024) { /* Mobile Nav Logic */ }
                        else setCurrentSection('categories');
                    } else if (currentSection === 'player') setCurrentSection('channels');
                    else handled = false;
                    break;
                case 'ArrowRight':
                    if (isCategorySection && elements.channels.length > 0) setCurrentSection('channels');
                    else if (isChannelSection) setCurrentSection('player');
                    else handled = false;
                    break;
                case 'Enter':
                    if (isChannelSection && elements.channels[focusedIndex]) {
                        const el = elements.channels[focusedIndex];
                        const data = {
                            num: el.getAttribute('data-channel-num'),
                            name: el.querySelector('.channel-name').textContent,
                            url: el.getAttribute('data-channel-url'),
                        };
                        selectChannel(data);
                        // Se for TV/Desktop, enter no canal pode ir fullscreen ou só tocar
                        // toggleFullPlayerMode(true); 
                    } else if (currentSection === 'player') toggleFullPlayerMode(true);
                    else handled = false;
                    break;
                default: handled = false;
            }

            if (handled) { e.preventDefault(); updateFocus(); }
        });

        // Handle click em categorias
        function initCategories() {
            elements.categories = Array.from(document.querySelectorAll('.category-item'));
            elements.categories.forEach((cat, index) => {
                cat.addEventListener('click', () => {
                    currentSection = 'categories';
                    focusedIndex = index;
                    updateFocus();
                    // No mobile, clicar na categoria pode focar no primeiro canal automaticamente?
                    // Render já acontece no updateFocus
                });
            });
        }

        function init() {
            initCategories();
            
            document.getElementById('fullscreen-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFullPlayerMode(!isFullPlayerMode);
            });
            
            elements.playerContainer.addEventListener('dblclick', () => toggleFullPlayerMode(!isFullPlayerMode));

            document.getElementById('volume-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                elements.videoPlayer.muted = !elements.videoPlayer.muted;
            });

            const initialCategoryName = elements.categories[0].getAttribute('data-category');
            renderChannels(initialCategoryName);
            
            const firstChannel = MOCK_CHANNELS["ESPORTES"][0];
            selectChannel(firstChannel);
            
            setCurrentSection('categories');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
